{"version":3,"sources":["index.ts"],"names":["STATE","JY","view","stage","titleStage","descriptStage","gameOverStage","controlStage","this","func","Function","interval","console","log","prototype","setup","currentState","loading","setState","document","addEventListener","event","preventDefault","window","returnValue","createStage","canvas","create","context","getContext","appendChild","run","remove","createControl","newGame","scoreInit","scoreScreen","Score","loadFile","title","bind","callback","_this","obj","files","length","_loop_1","v","count","type","_loop_2","i","l","item","img","Image","onload","checkLoaded","call","src","setTimeout","descript","desc","running","startTimer","over","gameOver","pause","stopTimer","play","clearInterval","timer","setInterval","clearRect","width","height","checkState","state","hits","oA","oB","bx","by","shape","SHAPE","rect","bw","w","aw","bh","h","ah","x","y","circle","r2","r","oAc","getCenter","oBc","Math","abs"],"mappings":"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","file":"index.js","sourcesContent":["/// <reference path=\"sprite.ts\" />\r\n/// <reference path=\"title.ts\" />\r\n/// <reference path=\"descript.ts\" />\r\n/// <reference path=\"gameOver.ts\" />\r\n/// <reference path=\"stage.ts\" />\r\n/// <reference path=\"control.ts\" />\r\n/// <reference path=\"score.ts\" />\r\n/// <reference path=\"writeText.ts\" />\r\n//游戏主框架\r\nenum STATE {\r\n    loading,\r\n    title,\r\n    descript,\r\n    newGame,\r\n    running,\r\n    pause,\r\n    levelUp,\r\n    die,\r\n    gameOver\r\n}\r\nclass JY {\r\n    private func: Function = new Function;\r\n    private timer: any;\r\n    private currentState: STATE;\r\n    protected interval: number = 10;\r\n    protected context: CanvasRenderingContext2D;\r\n    protected scoreScreen: Score;\r\n    files: any;\r\n    constructor(public view: HTMLElement, public stage: Stage, public titleStage: Title, public descriptStage: Discript, public gameOverStage?: GameOver, public controlStage?: Control) {\r\n        console.log(this.view)\r\n    }\r\n    setup() {\r\n        this.currentState = STATE.loading;\r\n        this.setState(STATE.loading);\r\n        document.addEventListener('touchmove', function (event) {\r\n            if (event.preventDefault) {\r\n                event.preventDefault();\r\n            } else {\r\n                window.event.returnValue == false;\r\n            }\r\n        });\r\n    }\r\n    createStage() {\r\n        console.log(this.stage)\r\n        let canvas = this.stage.create();\r\n        this.context = canvas.getContext('2d');\r\n        this.view.appendChild(canvas);\r\n    }\r\n    run() {\r\n        console.log('run')\r\n        //this.func();\r\n        this.descriptStage.remove();\r\n        this.createStage();//创建舞台\r\n        this.controlStage && this.createControl();\r\n        this.setState(STATE.newGame);\r\n    }\r\n    //分数面板\r\n    scoreInit() {\r\n        this.scoreScreen = new Score('--');\r\n        this.view.appendChild(this.scoreScreen.create());\r\n    }\r\n    createControl() {\r\n        this.view.appendChild(this.controlStage.create());\r\n    }\r\n    //加载\r\n    loading() {\r\n        this.loadFile(function () {\r\n            this.setState(STATE.title)\r\n        }.bind(this));\r\n    }\r\n    loadFile(callback: Function) {\r\n        let _this = this;\r\n        let obj: any = {};\r\n        if (_this.files.length > 0) {\r\n            for (let v in _this.files) {\r\n                obj[v] = {};\r\n                obj[v].count = 0;\r\n                let type = v;\r\n                console.log(_this.files[v])\r\n                for (let i = 0, l = _this.files[v].length; i < l; i++) {\r\n                    let item = _this.files[v][i];\r\n                    if (type == 'image') {\r\n                        let img = new Image();\r\n                        img.onload = function () {\r\n                            obj[v].count++;\r\n                            console.log(item + ' loaded');\r\n                            if (_this.checkLoaded(obj)) {\r\n                                callback.call(_this);\r\n                            }\r\n                        }\r\n                        img.src = item;\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            callback.call(_this);\r\n        }\r\n    }\r\n    checkLoaded(obj: any) {\r\n        for (var v in obj) {\r\n            if (obj[v].count != this.files[v].length) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n    //标题\r\n    title() {\r\n        console.log('title')\r\n        let titleStage = this.titleStage.create(function () {\r\n            this.run();\r\n        }.bind(this));\r\n        this.view.appendChild(titleStage);\r\n        setTimeout(function () {\r\n            this.titleStage.remove();\r\n            this.setState(STATE.descript)\r\n        }.bind(this), 1000);\r\n    }\r\n    //说明\r\n    descript() {\r\n        console.log('descript');\r\n        let desc = this.descriptStage.create(function () {\r\n            this.run();\r\n        }.bind(this));\r\n        this.view.appendChild(desc);\r\n    }\r\n    //新的开始\r\n    protected newGame() {\r\n        //游戏开始，清空场景\r\n        //打开计时器\r\n        this.scoreInit();\r\n        this.setState(STATE.running);\r\n        this.startTimer();\r\n    }\r\n    //结束 \r\n    protected over() {\r\n        this.setState(STATE.gameOver);\r\n    }\r\n    //暂停\r\n    protected pause() {\r\n        this.stopTimer();\r\n    }\r\n    //暂停后的继续\r\n    protected play() {\r\n        this.startTimer();\r\n    }\r\n    //游戏结束\r\n    protected gameOver() {\r\n        //游戏结束\r\n        //清空场景，显示结果\r\n        console.log('gameOver');\r\n        this.scoreScreen.remove();\r\n        this.stage.remove();\r\n        this.controlStage && this.controlStage.remove();\r\n        this.stopTimer();\r\n        let gameOver = this.gameOverStage.create(function () {\r\n            this.gameOverStage.remove();\r\n            this.setState(STATE.descript);\r\n        }.bind(this));\r\n        this.view.appendChild(gameOver);\r\n    }\r\n    //停止刷新\r\n    stopTimer() {\r\n        clearInterval(this.timer);\r\n    }\r\n    //刷新帧\r\n    startTimer() {\r\n        let _this = this;\r\n        this.timer = setInterval(function () {\r\n            _this.func.bind(_this)();\r\n        }, this.interval)\r\n    }\r\n    //游戏中的\r\n    running() {\r\n        // console.log('running...')\r\n        \r\n        this.context.clearRect(0, 0, this.stage.width, this.stage.height);\r\n    }\r\n    //检查状态\r\n    checkState() {\r\n        switch (this.currentState) {\r\n            case STATE.loading:\r\n                this.func = this.loading;\r\n                break;\r\n            case STATE.title:\r\n                this.func = this.title;\r\n                break;\r\n            case STATE.descript:\r\n                this.func = this.descript;\r\n                break;\r\n            case STATE.newGame:\r\n                this.func = this.newGame;\r\n                break;\r\n            case STATE.running:\r\n                this.func = this.running;\r\n                break;\r\n            case STATE.gameOver:\r\n                this.func = this.gameOver;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n    setState(state?: STATE) {\r\n        this.currentState = state;\r\n        this.checkState();\r\n        this.func();\r\n    }\r\n    //碰撞检测\r\n    hits(oA: Sprite, oB: Sprite) {\r\n        var bx = false,\r\n            by = false;\r\n        if (oA.shape == SHAPE.rect) {\r\n            var bw = oB.w;\r\n            var aw = oA.w;\r\n            var bh = oB.h;\r\n            var ah = oA.h;\r\n            if (oA.x > oB.x) {\r\n                bx = oA.x - oB.x < bw;\r\n            } else if (oA.x < oB.x) {\r\n                bx = oB.x - oA.x < aw;\r\n            } else {\r\n                bx = true;\r\n            };\r\n            if (oA.y > oB.y) {\r\n                by = oA.y - oB.y < bh;\r\n            } else if (oA.y < oB.y) {\r\n                by = oB.y - oA.y < ah;\r\n            } else {\r\n                by = true;\r\n            };\r\n            return (bx && by);\r\n        } else if (oA.shape == SHAPE.circle) {\r\n            var r2 = oA.r + oB.r;\r\n            let oAc = oA.getCenter();\r\n            let oBc = oB.getCenter();\r\n            bx = Math.abs(oAc[0] - oBc[0]) < r2;\r\n            by = Math.abs(oAc[1] - oBc[1]) < r2;\r\n            return (bx && by);\r\n        }\r\n    }\r\n}"]}